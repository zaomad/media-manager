{% extends "base.html" %}

{% block title %}电影管理 - 书影音管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>我的电影</h1>
    <a href="{{ url_for('add_movie_route') }}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> 添加电影
    </a>
</div>

<div id="movies-app">
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="搜索电影..." v-model="searchQuery">
                <button class="btn btn-outline-secondary" type="button" @click="search">
                    <i class="bi bi-search"></i> 搜索
                </button>
            </div>
        </div>
        <div class="col-md-6">
            <select class="form-select" v-model="filterStatus">
                <option value="">所有状态</option>
                <option value="unwatched">未看</option>
                <option value="watching">在看</option>
                <option value="watched">已看</option>
            </select>
        </div>
    </div>

    <!-- 筛选器容器 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="genre-filter-container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="filter-type-toggle btn-group" role="group">
                        <button id="genreFilterTypeBtn" class="btn btn-sm btn-outline-primary active">按分类筛选</button>
                        <button id="directorFilterTypeBtn" class="btn btn-sm btn-outline-primary">按导演筛选</button>
                        <button id="castFilterTypeBtn" class="btn btn-sm btn-outline-primary">按演员筛选</button>
                    </div>
                    <button id="clearFilterBtn" class="btn btn-sm btn-outline-secondary">清除筛选</button>
                </div>
                <div class="genre-dropdown">
                    <div class="genre-input-container">
                        <div class="form-control genre-input" id="genreFilter">
                            <span class="genre-input-placeholder" id="filterPlaceholder">选择或搜索分类标签...</span>
                        </div>
                        <div class="genre-search-icon" id="genreSearchBtn">
                            <i class="bi bi-funnel-fill"></i>
                        </div>
                    </div>
                    <div class="genre-dropdown-menu" id="genreDropdownMenu">
                        <div class="mb-2">
                            <input type="text" class="form-control" id="genreSearchInput" placeholder="搜索...">
                        </div>
                        
                        <!-- 分类标签容器 -->
                        <div class="genre-tags-container" id="genreTagsContainer">
                            <div class="row row-cols-3 g-2 w-100">
                                {% for genre in genres %}
                                <div class="col genre-tag-item filter-genre-item">
                                    <input type="checkbox" class="genre-checkbox" id="genre_{{ loop.index }}" value="{{ genre }}">
                                    <label class="genre-label w-100 text-center" for="genre_{{ loop.index }}">{{ genre }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- 导演标签容器 -->
                        <div class="author-tags-container" id="directorTagsContainer" style="display: none;">
                            <div class="row row-cols-3 g-2 w-100">
                                {% for director in directors %}
                                <div class="col director-tag-item filter-director-item">
                                    <input type="radio" class="director-radio" id="director_{{ loop.index }}" name="director" value="{{ director }}">
                                    <label class="genre-label w-100 text-center" for="director_{{ loop.index }}">{{ director }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- 演员标签容器 -->
                        <div class="author-tags-container" id="castTagsContainer" style="display: none;">
                            <div class="row row-cols-3 g-2 w-100">
                                {% for actor in actors %}
                                <div class="col cast-tag-item filter-cast-item">
                                    <input type="checkbox" class="cast-checkbox" id="cast_{{ loop.index }}" value="{{ actor }}">
                                    <label class="genre-label w-100 text-center" for="cast_{{ loop.index }}">{{ actor }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 视图切换按钮 -->
    <div class="view-toggle d-flex justify-content-end mb-3">
        <div class="btn-group" role="group" aria-label="视图切换">
            <button type="button" class="btn btn-outline-secondary active" data-view="grid">
                <i class="bi bi-grid-3x3-gap"></i> 卡片视图
            </button>
            <button type="button" class="btn btn-outline-secondary" data-view="list">
                <i class="bi bi-list-ul"></i> 列表视图
            </button>
            <button type="button" class="btn btn-outline-secondary" data-view="table">
                <i class="bi bi-table"></i> 表格视图
            </button>
        </div>
    </div>

    <!-- 媒体容器 -->
    <div class="media-container grid-view">
        <!-- 卡片视图 -->
        <div class="view-content grid-content">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for movie in movies %}
                <div class="col movie-item" 
                    data-title="{{ movie.title|lower }}" 
                    data-director="{{ movie.director|lower }}" 
                    data-cast="{{ movie.cast|lower }}"
                    data-status="{{ movie.status }}"
                    data-year="{{ movie.year }}"
                    data-genre="{{ movie.genre|lower }}"
                    data-rating="{{ movie.rating }}">
                    <div class="card h-100">
                        {% if movie.poster_url %}
                        <img src="{{ movie.poster_url }}" class="card-img-top" alt="{{ movie.title }}" style="height: 300px; object-fit: cover;">
                        {% else %}
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                            <i class="bi bi-film" style="font-size: 3rem;"></i>
                        </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ movie.title }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ movie.director }}</h6>
                            <p class="card-text">
                                {% if movie.year %}<small class="text-muted">{{ movie.year }}</small>{% endif %}
                                {% if movie.genre %}<small class="text-muted">{{ movie.genre }}</small>{% endif %}
                            </p>
                            {% if movie.rating %}
                            <div class="mb-2">
                                {% for i in range(1, movie.rating|int + 1) %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% endfor %}
                                {% if movie.rating|float % 1 >= 0.5 %}
                                    <i class="bi bi-star-half text-warning"></i>
                                {% endif %}
                            </div>
                            {% endif %}
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge {% if movie.status == 'watched' %}bg-success{% elif movie.status == 'watching' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {% if movie.status == 'watched' %}已看
                                    {% elif movie.status == 'watching' %}在看
                                    {% else %}未看
                                    {% endif %}
                                </span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary details-btn" data-id="{{ movie.id }}">
                                        <i class="bi bi-info-circle"></i> 详情
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button class="btn btn-sm btn-outline-danger delete-movie-btn" data-id="{{ movie.id }}" style="display: none;">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <a href="{{ url_for('edit_movie_route', movie_id=movie.id) }}" class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    <i class="bi bi-pencil"></i> 编辑
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info" role="alert">
                        您还没有添加任何电影。<a href="{{ url_for('add_movie_route') }}" class="alert-link">添加一部电影</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 列表视图 -->
        <div class="view-content list-content" style="display: none;">
            {% if movies %}
                {% for movie in movies %}
                <div class="media-item movie-item"
                     data-title="{{ movie.title|lower }}" 
                     data-director="{{ movie.director|lower }}" 
                     data-cast="{{ movie.cast|lower }}"
                     data-status="{{ movie.status }}"
                     data-year="{{ movie.year }}"
                     data-genre="{{ movie.genre|lower }}"
                     data-rating="{{ movie.rating }}">
                    <div class="media-row">
                        {% if movie.poster_url %}
                        <img src="{{ movie.poster_url }}" class="media-thumbnail" alt="{{ movie.title }}">
                        {% else %}
                        <div class="media-thumbnail bg-light d-flex align-items-center justify-content-center">
                            <i class="bi bi-film"></i>
                        </div>
                        {% endif %}
                        <div class="media-content">
                            <div class="media-title">{{ movie.title }}</div>
                            <div class="media-info">
                                <span>{{ movie.director }}</span>
                                {% if movie.year %} · <span>{{ movie.year }}</span>{% endif %}
                                {% if movie.genre %} · <span>{{ movie.genre }}</span>{% endif %}
                                <span class="badge ms-2 {% if movie.status == 'watched' %}bg-success{% elif movie.status == 'watching' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {% if movie.status == 'watched' %}已看
                                    {% elif movie.status == 'watching' %}在看
                                    {% else %}未看
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="media-rating">
                            {% if movie.rating %}
                                {% for i in range(1, movie.rating|int + 1) %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% endfor %}
                                {% if movie.rating|float % 1 >= 0.5 %}
                                    <i class="bi bi-star-half text-warning"></i>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-outline-primary details-btn me-1" data-id="{{ movie.id }}">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-movie-btn me-1" data-id="{{ movie.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                            <a href="{{ url_for('edit_movie_route', movie_id=movie.id) }}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info" role="alert">
                    您还没有添加任何电影。<a href="{{ url_for('add_movie_route') }}" class="alert-link">添加一部电影</a>
                </div>
            {% endif %}
        </div>

        <!-- 表格视图 -->
        <div class="view-content table-content" style="display: none;">
            {% if movies %}
            <div class="table-responsive table-view">
                <table class="table table-hover table-sortable">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 60px;">#</th>
                            <th scope="col" class="sortable" data-sort="title">标题 <i class="bi bi-arrow-down-short"></i></th>
                            <th scope="col" class="sortable" data-sort="director">导演 <i class="bi bi-arrow-down-short"></i></th>
                            <th scope="col">主演</th>
                            <th scope="col" class="sortable" data-sort="year">年份 <i class="bi bi-arrow-down-short"></i></th>
                            <th scope="col">类型</th>
                            <th scope="col">状态</th>
                            <th scope="col" class="sortable" data-sort="rating">评分 <i class="bi bi-arrow-down-short"></i></th>
                            <th scope="col" style="width: 100px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movie in movies %}
                        <tr class="movie-item"
                            data-title="{{ movie.title|lower }}" 
                            data-director="{{ movie.director|lower }}" 
                            data-cast="{{ movie.cast|lower }}"
                            data-status="{{ movie.status }}"
                            data-year="{{ movie.year }}"
                            data-genre="{{ movie.genre|lower }}"
                            data-rating="{{ movie.rating }}">
                            <td>
                                {% if movie.poster_url %}
                                <img src="{{ movie.poster_url }}" class="media-thumbnail" alt="{{ movie.title }}">
                                {% else %}
                                <div class="media-thumbnail bg-light d-flex align-items-center justify-content-center">
                                    <i class="bi bi-film"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td>{{ movie.title }}</td>
                            <td>{{ movie.director }}</td>
                            <td>{{ movie.cast }}</td>
                            <td>{{ movie.year }}</td>
                            <td>{{ movie.genre }}</td>
                            <td>
                                <span class="badge {% if movie.status == 'watched' %}bg-success{% elif movie.status == 'watching' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {% if movie.status == 'watched' %}已看
                                    {% elif movie.status == 'watching' %}在看
                                    {% else %}未看
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if movie.rating %}
                                    {% for i in range(1, movie.rating|int + 1) %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% endfor %}
                                    {% if movie.rating|float % 1 >= 0.5 %}
                                        <i class="bi bi-star-half text-warning"></i>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary details-btn" data-id="{{ movie.id }}">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-movie-btn" data-id="{{ movie.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <a href="{{ url_for('edit_movie_route', movie_id=movie.id) }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-info" role="alert">
                    您还没有添加任何电影。<a href="{{ url_for('add_movie_route') }}" class="alert-link">添加一部电影</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    th.sortable {
        cursor: pointer;
    }
    th.sortable:hover {
        background-color: #f8f9fa;
    }
    th.sortable[data-direction="asc"] i {
        transform: rotate(0deg);
    }
    th.sortable[data-direction="desc"] i {
        transform: rotate(180deg);
    }
    
    /* 分类标签过滤器样式 */
    .genre-filter-container {
        margin-bottom: 15px;
        position: relative;
    }
    .genre-filter-title {
        font-weight: bold;
        margin-bottom: 8px;
    }
    .genre-dropdown {
        position: relative;
    }
    .genre-input-container {
        position: relative;
    }
    .genre-input {
        min-height: 38px;
        height: auto;
        padding: 0.375rem 40px 0.375rem 0.75rem;
        cursor: pointer;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 5px;
    }
    .genre-input-placeholder {
        color: #6c757d;
    }
    .genre-search-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        z-index: 5;
    }
    .genre-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1000;
        padding: 0.5rem;
        display: none;
    }
    .genre-dropdown-menu.show {
        display: block;
    }
    .genre-tags-container, .director-tags-container, .cast-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .genre-tag-item, .director-tag-item, .cast-tag-item {
        margin-bottom: 5px;
    }
    .genre-checkbox, .director-radio, .cast-checkbox {
        display: none;
    }
    .genre-label {
        display: inline-block;
        padding: 5px 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    .genre-checkbox:checked + .genre-label, 
    .director-radio:checked + .genre-label, 
    .cast-checkbox:checked + .genre-label {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    .selected-genre-tag {
        display: inline-flex;
        align-items: center;
        background-color: #e9ecef;
        border-radius: 16px;
        padding: 2px 8px;
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }
    .selected-genre-tag .remove-genre {
        margin-left: 5px;
        cursor: pointer;
        color: #6c757d;
    }
    .selected-genre-tag .remove-genre:hover {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    new Vue({
        el: '#movies-app',
        data: {
            searchQuery: '',
            filterStatus: ''
        },
        methods: {
            search: function() {
                const query = this.searchQuery.toLowerCase();
                const status = this.filterStatus;
                
                document.querySelectorAll('.movie-item').forEach(item => {
                    const title = item.dataset.title;
                    const director = item.dataset.director;
                    const itemStatus = item.dataset.status;
                    
                    const matchesSearch = title.includes(query) || director.includes(query);
                    const matchesStatus = !status || itemStatus === status;
                    
                    if (matchesSearch && matchesStatus) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        },
        watch: {
            filterStatus: function() {
                this.search();
            }
        },
        mounted: function() {
            // 从本地存储加载视图偏好
            const preferredView = localStorage.getItem('preferredView') || 'grid';
            
            // 更新视图切换按钮状态
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                if (btn.getAttribute('data-view') === preferredView) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
    });

    // 将电影数据转换为JavaScript变量
    var moviesData = [];
    try {
        moviesData = JSON.parse('{{ movies|tojson|safe }}');
    } catch (e) {
        console.error('Error parsing movies data:', e);
        moviesData = [];
    }
    
    // 删除电影函数
    function deleteMovie(movieId) {
        if (confirm('确定要删除这部电影吗？此操作无法撤销。')) {
            fetch('/movies/' + movieId + '/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('电影已成功删除');
                    // 刷新页面
                    window.location.reload();
                } else {
                    throw new Error('删除失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除电影时出错: ' + error.message);
            });
        }
    }
    
    // 详情按钮处理
    function viewMovieDetails(movieId) {
        window.location.href = '/movies/' + movieId;
    }

    // 初始化筛选器
    function initializeFilters() {
        // 获取元素
        const genreFilter = document.getElementById('genreFilter');
        const filterPlaceholder = document.getElementById('filterPlaceholder');
        const genreDropdown = document.getElementById('genreDropdownMenu');
        const genreSearchBtn = document.getElementById('genreSearchBtn');
        const genreSearchInput = document.getElementById('genreSearchInput');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        
        // 筛选类型按钮
        const genreFilterTypeBtn = document.getElementById('genreFilterTypeBtn');
        const directorFilterTypeBtn = document.getElementById('directorFilterTypeBtn');
        const castFilterTypeBtn = document.getElementById('castFilterTypeBtn');
        
        // 标签容器
        const genreTagsContainer = document.getElementById('genreTagsContainer');
        const directorTagsContainer = document.getElementById('directorTagsContainer');
        const castTagsContainer = document.getElementById('castTagsContainer');
        
        // 复选框
        const genreCheckboxes = document.querySelectorAll('.genre-checkbox');
        const directorRadios = document.querySelectorAll('.director-radio');
        const castCheckboxes = document.querySelectorAll('.cast-checkbox');
        
        // 当前筛选类型
        let currentFilterType = 'genre';
        
        // 显示下拉框
        function showDropdown() {
            genreDropdown.classList.add('show');
            
            // 点击外部关闭下拉框
            document.addEventListener('click', handleOutsideClick);
        }
        
        // 隐藏下拉框
        function hideDropdown() {
            genreDropdown.classList.remove('show');
            document.removeEventListener('click', handleOutsideClick);
        }
        
        // 处理外部点击
        function handleOutsideClick(e) {
            const isDropdownClick = genreDropdown.contains(e.target) || 
                                    genreFilter.contains(e.target) || 
                                    genreSearchBtn.contains(e.target);
            
            if (!isDropdownClick) {
                hideDropdown();
            }
        }
        
        // 更新已选分类显示
        function updateSelectedGenres() {
            // 清除所有现有标签和占位符
            const existingTags = genreFilter.querySelectorAll('.selected-genre-tag');
            existingTags.forEach(tag => tag.remove());
            
            const selectedGenres = [];
            
            genreCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const genreValue = checkbox.value;
                    selectedGenres.push(genreValue);
                    
                    // 创建标签元素
                    const tag = document.createElement('span');
                    tag.className = 'selected-genre-tag';
                    tag.innerHTML = `
                        ${genreValue}
                        <span class="remove-genre" data-genre="${genreValue}">×</span>
                    `;
                    
                    // 在占位符之前插入标签
                    genreFilter.insertBefore(tag, filterPlaceholder);
                }
            });
            
            // 切换占位符的可见性
            if (selectedGenres.length > 0) {
                filterPlaceholder.style.display = 'none';
            } else {
                filterPlaceholder.style.display = '';
            }
            
            // 为移除按钮添加事件
            document.querySelectorAll('.remove-genre').forEach(btn => {
                if (btn.dataset.genre) {  // 确保这是一个分类标签
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const genre = this.dataset.genre;
                        
                        // 取消对应的复选框
                        document.querySelector(`.genre-checkbox[value="${genre}"]`).checked = false;
                        updateSelectedGenres();
                        
                        // 实时筛选
                        filterMovies();
                    });
                }
            });
            
            // 实时筛选
            filterMovies();
        }
        
        // 更新已选导演显示
        function updateSelectedDirectors() {
            // 清除所有现有标签和占位符
            const existingTags = genreFilter.querySelectorAll('.selected-genre-tag');
            existingTags.forEach(tag => tag.remove());
            
            let selectedDirector = '';
            
            const checkedRadio = document.querySelector('.director-radio:checked');
            if (checkedRadio) {
                selectedDirector = checkedRadio.value;
                
                // 创建标签元素
                const tag = document.createElement('span');
                tag.className = 'selected-genre-tag';
                tag.innerHTML = `
                    ${selectedDirector}
                    <span class="remove-genre" data-director="${selectedDirector}">×</span>
                `;
                
                // 在占位符之前插入标签
                genreFilter.insertBefore(tag, filterPlaceholder);
                
                // 切换占位符的可见性
                filterPlaceholder.style.display = 'none';
            } else {
                filterPlaceholder.style.display = '';
            }
            
            // 为移除按钮添加事件
            document.querySelectorAll('.remove-genre').forEach(btn => {
                if (btn.dataset.director) {  // 确保这是一个导演标签
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // 取消选中的单选按钮
                        const checkedRadio = document.querySelector('.director-radio:checked');
                        if (checkedRadio) {
                            checkedRadio.checked = false;
                        }
                        
                        updateSelectedDirectors();
                        
                        // 实时筛选
                        filterMovies();
                    });
                }
            });
            
            // 实时筛选
            filterMovies();
        }
        
        // 更新已选演员显示
        function updateSelectedCasts() {
            // 清除所有现有标签和占位符
            const existingTags = genreFilter.querySelectorAll('.selected-genre-tag');
            existingTags.forEach(tag => tag.remove());
            
            const selectedCasts = [];
            
            castCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const castValue = checkbox.value;
                    selectedCasts.push(castValue);
                    
                    // 创建标签元素
                    const tag = document.createElement('span');
                    tag.className = 'selected-genre-tag';
                    tag.innerHTML = `
                        ${castValue}
                        <span class="remove-genre" data-cast="${castValue}">×</span>
                    `;
                    
                    // 在占位符之前插入标签
                    genreFilter.insertBefore(tag, filterPlaceholder);
                }
            });
            
            // 切换占位符的可见性
            if (selectedCasts.length > 0) {
                filterPlaceholder.style.display = 'none';
            } else {
                filterPlaceholder.style.display = '';
            }
            
            // 为移除按钮添加事件
            document.querySelectorAll('.remove-genre').forEach(btn => {
                if (btn.dataset.cast) {  // 确保这是一个演员标签
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const cast = this.dataset.cast;
                        
                        // 取消对应的复选框
                        document.querySelector(`.cast-checkbox[value="${cast}"]`).checked = false;
                        updateSelectedCasts();
                        
                        // 实时筛选
                        filterMovies();
                    });
                }
            });
            
            // 实时筛选
            filterMovies();
        }
        
        // 筛选标签
        function filterTags(query) {
            const normalizedQuery = query.toLowerCase();
            
            if (currentFilterType === 'genre') {
                document.querySelectorAll('.filter-genre-item').forEach(item => {
                    const label = item.querySelector('.genre-label');
                    const text = label.textContent.toLowerCase();
                    
                    if (text.includes(normalizedQuery)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else if (currentFilterType === 'director') {
                document.querySelectorAll('.filter-director-item').forEach(item => {
                    const label = item.querySelector('.genre-label');
                    const text = label.textContent.toLowerCase();
                    
                    if (text.includes(normalizedQuery)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else {
                document.querySelectorAll('.filter-cast-item').forEach(item => {
                    const label = item.querySelector('.genre-label');
                    const text = label.textContent.toLowerCase();
                    
                    if (text.includes(normalizedQuery)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        }
        
        // 清除所有选择
        function clearFilterSelection() {
            if (currentFilterType === 'genre') {
                genreCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateSelectedGenres();
            } else if (currentFilterType === 'director') {
                const checkedRadio = document.querySelector('.director-radio:checked');
                if (checkedRadio) {
                    checkedRadio.checked = false;
                }
                updateSelectedDirectors();
            } else {
                castCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateSelectedCasts();
            }
        }

        // 切换筛选类型
        function switchFilterType(type) {
            currentFilterType = type;
            
            if (type === 'genre') {
                // 切换到分类筛选
                genreFilterTypeBtn.classList.add('active');
                directorFilterTypeBtn.classList.remove('active');
                castFilterTypeBtn.classList.remove('active');
                
                genreTagsContainer.style.display = '';
                directorTagsContainer.style.display = 'none';
                castTagsContainer.style.display = 'none';
                
                filterPlaceholder.textContent = '选择或搜索分类标签...';
                
                // 显示分类选择
                updateSelectedGenres();
            } else if (type === 'director') {
                // 切换到导演筛选
                genreFilterTypeBtn.classList.remove('active');
                directorFilterTypeBtn.classList.add('active');
                castFilterTypeBtn.classList.remove('active');
                
                genreTagsContainer.style.display = 'none';
                directorTagsContainer.style.display = '';
                castTagsContainer.style.display = 'none';
                
                filterPlaceholder.textContent = '选择或搜索导演...';
                
                // 显示导演选择
                updateSelectedDirectors();
            } else {
                // 切换到演员筛选
                genreFilterTypeBtn.classList.remove('active');
                directorFilterTypeBtn.classList.remove('active');
                castFilterTypeBtn.classList.add('active');
                
                genreTagsContainer.style.display = 'none';
                directorTagsContainer.style.display = 'none';
                castTagsContainer.style.display = '';
                
                filterPlaceholder.textContent = '选择或搜索演员...';
                
                // 显示演员选择
                updateSelectedCasts();
            }
            
            // 清空搜索框
            genreSearchInput.value = '';
        }
        
        // 筛选电影
        function filterMovies() {
            const moviesApp = document.getElementById('movies-app').__vue__;
            const searchQuery = moviesApp.searchQuery.toLowerCase();
            const statusFilter = moviesApp.filterStatus;
            
            // 获取选中的分类、导演和演员
            const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            const selectedDirector = document.querySelector('.director-radio:checked')?.value || '';
            
            const selectedCasts = Array.from(document.querySelectorAll('.cast-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            const allMovies = document.querySelectorAll('.movie-item');
            
            allMovies.forEach(movie => {
                const title = movie.dataset.title.toLowerCase();
                const director = movie.dataset.director.toLowerCase();
                const cast = movie.dataset.cast ? movie.dataset.cast.toLowerCase() : '';
                const status = movie.dataset.status;
                const genres = movie.dataset.genre ? movie.dataset.genre.split(',').map(g => g.trim().toLowerCase()) : [];
                
                // 搜索匹配 (标题或导演)
                const matchesSearch = !searchQuery || 
                    title.includes(searchQuery) || 
                    director.includes(searchQuery) ||
                    cast.includes(searchQuery);
                
                // 状态匹配
                const matchesStatus = !statusFilter || status === statusFilter;
                
                // 分类匹配 (必须匹配所有选定的分类标签)
                let matchesGenre = selectedGenres.length === 0; // 如果没有选中分类，则默认匹配
                
                if (!matchesGenre) {
                    // 检查电影是否包含所有选定的分类
                    matchesGenre = selectedGenres.every(filter => {
                        // 查找电影的任一分类是否包含此过滤标签
                        return genres.some(movieGenre => movieGenre.includes(filter.toLowerCase()));
                    });
                }
                
                // 导演匹配
                let matchesDirector = !selectedDirector; // 如果没有选中导演，则默认匹配
                
                if (!matchesDirector) {
                    matchesDirector = director === selectedDirector.toLowerCase();
                }
                
                // 演员匹配 (任一选中的演员出现在演员列表中)
                let matchesCast = selectedCasts.length === 0; // 如果没有选中演员，则默认匹配
                
                if (!matchesCast && cast) {
                    // 检查电影的演员是否匹配任一选中的演员
                    matchesCast = selectedCasts.some(selectedCast => 
                        cast.includes(selectedCast.toLowerCase())
                    );
                }
                
                // 根据当前筛选类型应用过滤
                let matchesCurrentFilter = true;
                if (currentFilterType === 'genre') {
                    matchesCurrentFilter = matchesGenre;
                } else if (currentFilterType === 'director') {
                    matchesCurrentFilter = matchesDirector;
                } else { // cast
                    matchesCurrentFilter = matchesCast;
                }
                
                // 应用筛选
                if (matchesSearch && matchesStatus && matchesCurrentFilter) {
                    movie.style.display = '';
                } else {
                    movie.style.display = 'none';
                }
            });
        }
        
        // 事件监听器
        genreFilter.addEventListener('click', showDropdown);
        genreSearchBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (genreDropdown.classList.contains('show')) {
                hideDropdown();
            } else {
                showDropdown();
            }
        });
        
        genreSearchInput.addEventListener('input', function() {
            filterTags(this.value);
        });
        
        genreSearchInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        clearFilterBtn.addEventListener('click', function() {
            clearFilterSelection();
        });
        
        // 筛选类型切换事件
        genreFilterTypeBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                switchFilterType('genre');
            }
        });
        
        directorFilterTypeBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                switchFilterType('director');
            }
        });
        
        castFilterTypeBtn.addEventListener('click', function() {
            if (!this.classList.contains('active')) {
                switchFilterType('cast');
            }
        });
        
        genreCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedGenres();
            });
        });
        
        directorRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updateSelectedDirectors();
            });
        });
        
        castCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCasts();
            });
        });
    }

    // 为按钮添加事件监听
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化筛选器
        initializeFilters();
        
        // 删除按钮处理
        document.querySelectorAll('.delete-movie-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const movieId = this.getAttribute('data-id');
                deleteMovie(movieId);
            });
        });
        
        // 详情按钮处理
        document.querySelectorAll('.details-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const movieId = this.getAttribute('data-id');
                viewMovieDetails(movieId);
            });
        });
        
        // 表格排序功能
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const field = this.getAttribute('data-sort');
                let direction = this.getAttribute('data-direction') || 'asc';
                
                // 切换排序方向
                direction = direction === 'asc' ? 'desc' : 'asc';
                
                // 重置所有表头的排序方向
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.removeAttribute('data-direction');
                });
                
                // 设置当前表头的排序方向
                this.setAttribute('data-direction', direction);
                
                // 获取表格和行
                const table = this.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr.movie-item:not([style*="display: none"])'));
                
                // 排序行
                rows.sort((a, b) => {
                    let valueA, valueB;
                    
                    if (field === 'title') {
                        valueA = a.dataset.title;
                        valueB = b.dataset.title;
                    } else if (field === 'director') {
                        valueA = a.dataset.director;
                        valueB = b.dataset.director;
                    } else if (field === 'year') {
                        valueA = parseInt(a.dataset.year) || 0;
                        valueB = parseInt(b.dataset.year) || 0;
                        return direction === 'asc' ? valueA - valueB : valueB - valueA;
                    } else if (field === 'rating') {
                        valueA = parseFloat(a.dataset.rating) || 0;
                        valueB = parseFloat(b.dataset.rating) || 0;
                        console.log(`Comparing ratings: ${valueA} vs ${valueB}`);
                        return direction === 'asc' ? valueA - valueB : valueB - valueA;
                    }
                    
                    // 对于字符串类型，使用 localeCompare 进行比较
                    if (typeof valueA === 'string' && typeof valueB === 'string') {
                        return direction === 'asc' 
                            ? valueA.localeCompare(valueB) 
                            : valueB.localeCompare(valueA);
                    }
                    
                    return 0;
                });
                
                // 重新排列行
                rows.forEach(row => {
                    tbody.appendChild(row);
                });
            });
        });
        
        // 视图切换
        document.querySelectorAll('.view-toggle .btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const viewType = this.getAttribute('data-view');
                
                // 更新按钮状态
                document.querySelectorAll('.view-toggle .btn').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                
                // 更新视图
                const container = document.querySelector('.media-container');
                container.className = 'media-container ' + viewType + '-view';
                
                // 显示/隐藏相应内容
                document.querySelectorAll('.view-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.querySelector('.' + viewType + '-content').style.display = '';
                
                // 保存偏好
                localStorage.setItem('preferredView', viewType);
            });
        });
        
        // 初始化视图
        const preferredView = localStorage.getItem('preferredView') || 'grid';
        document.querySelector(`.view-toggle .btn[data-view="${preferredView}"]`).click();
    });
</script>
{% endblock %} 