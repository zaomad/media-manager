# JSON 到 SQLite 迁移指南

本文档介绍如何将媒体管理系统的数据存储从 JSON 文件迁移到 SQLite 数据库。

## 迁移前准备

1. 确保您的系统已安装 Python 3.8 或更高版本
2. 确保已安装所有依赖项：`pip install -r requirements.txt`
3. 备份您的数据（迁移脚本会自动备份，但额外的备份总是好的）

## 迁移步骤

### 1. 执行迁移脚本

运行以下命令执行迁移：

```bash
python migrate_to_sqlite.py
```

如果数据库文件已存在，脚本会询问是否覆盖。如果您想强制覆盖，可以使用 `--force` 参数：

```bash
python migrate_to_sqlite.py --force
```

### 2. 验证迁移结果

迁移完成后，运行测试脚本验证 SQLite 数据库是否正常工作：

```bash
python test_sqlite.py
```

如果所有测试都通过，说明迁移成功。

### 3. 启动应用

现在您可以启动应用程序，它将使用 SQLite 数据库而不是 JSON 文件：

```bash
python run.py
```

## 数据库结构

迁移后的 SQLite 数据库包含以下表：

1. **books**: 存储书籍信息
2. **movies**: 存储电影信息
3. **music**: 存储音乐信息
4. **tags**: 存储标签信息
5. **item_tags**: 存储项目与标签的关联关系

## 迁移后的优势

使用 SQLite 数据库相比 JSON 文件有以下优势：

- **更高效的查询**: 特别是对于大型数据集，SQLite 的查询性能远优于 JSON
- **更好的数据完整性**: 数据库约束确保数据的一致性
- **支持复杂查询**: 可以执行更复杂的搜索和过滤操作
- **减少内存使用**: 不需要将整个数据集加载到内存中
- **并发访问**: 更好地支持并发读写操作

## 故障排除

### 迁移失败

如果迁移失败，请检查：

1. 数据目录是否存在
2. JSON 文件是否有效
3. 是否有足够的磁盘空间
4. 是否有数据库文件的写入权限

### 数据不一致

如果发现迁移后的数据不一致，您可以：

1. 检查 `data/backup/` 目录中的 JSON 备份
2. 重新运行迁移脚本
3. 如果问题持续存在，请报告问题

## 回滚到 JSON 存储

如果您需要回滚到 JSON 存储，只需编辑 `app/models.py` 文件，恢复原始的 JSON 处理代码。原始的 JSON 文件在迁移过程中不会被修改。 